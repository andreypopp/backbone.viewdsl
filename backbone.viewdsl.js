// Generated by CoffeeScript 1.4.0
var __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

(function(root, factory) {
  if (typeof define === 'function' && define.amd) {
    return define(['jquery', 'rsvp', 'backbone', 'underscore'], function(jQuery, RSVP, Backbone, _) {
      jQuery = jQuery || root.jQuery;
      RSVP = RSVP || root.RSVP;
      Backbone = Backbone || root.Backbone;
      _ = _ || root._;
      return root.Backbone.ViewDSL = factory(jQuery, RSVP, Backbone, _);
    });
  } else {
    return root.Backbone.ViewDSL = factory(root.jQuery, root.RSVP, root.Backbone, root._);
  }
})(this, function(jQuery, RSVP, Backbone, _) {
  var View, getByPath, getBySpec, hypensToCamelCase, join, processAttributes, processNode, processTextNode, promise, promiseRequire, replaceChild, textNodeSplitRe, toArray, wrapTemplate;
  RSVP.Promise.prototype.end = function() {
    return this.then(void 0, function(e) {
      throw e;
    });
  };
  toArray = function(o) {
    return Array.prototype.slice.call(o);
  };
  getByPath = function(o, p) {
    var ctx, n, _i, _len, _ref;
    if (p.trim().length === 0) {
      return [o, window];
    }
    _ref = p.split('.');
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      n = _ref[_i];
      ctx = o;
      o = ctx[n];
      if (o === void 0) {
        break;
      }
    }
    return [o, ctx];
  };
  getBySpec = function(spec) {
    var module, path, _ref;
    if (/:/.test(spec)) {
      _ref = spec.split(':', 2), module = _ref[0], path = _ref[1];
      return promiseRequire(module).then(function(module) {
        return getByPath(module, path)[0];
      });
    } else {
      return promise(getByPath(window, spec)[0]);
    }
  };
  promise = function(value) {
    var p;
    p = new RSVP.Promise();
    p.resolve(value);
    return p;
  };
  join = function(promises) {
    var idx, p, pr, results, resultsToGo, _fn, _i, _len,
      _this = this;
    p = new RSVP.Promise();
    results = [];
    if (promises.length > 0) {
      resultsToGo = promises.length;
      _fn = function(pr, idx) {
        return pr.then(function(result) {
          results[idx] = result;
          resultsToGo = resultsToGo - 1;
          if (resultsToGo === 0) {
            return p.resolve(results);
          }
        });
      };
      for (idx = _i = 0, _len = promises.length; _i < _len; idx = ++_i) {
        pr = promises[idx];
        _fn(pr, idx);
      }
    } else {
      p.resolve(results);
    }
    return p;
  };
  promiseRequire = function(moduleName) {
    var p;
    p = new RSVP.Promise();
    require([moduleName], function(module) {
      return p.resolve(module);
    });
    return p;
  };
  hypensToCamelCase = function(o) {
    return o.replace(/-([a-z])/g, function(g) {
      return g[1].toUpperCase();
    });
  };
  replaceChild = function(node, old, news) {
    var n, nn, _i, _j, _len, _len1;
    for (_i = 0, _len = news.length; _i < _len; _i++) {
      n = news[_i];
      if (typeof n.cloneNode === 'function') {
        node.insertBefore(n, old);
      } else if (typeof n.item === 'function' && n.length || n.jquery) {
        for (_j = 0, _len1 = n.length; _j < _len1; _j++) {
          nn = n[_j];
          node.insertBefore(nn, old);
        }
      } else {
        n = document.createTextNode(String(n));
        node.insertBefore(n, old);
      }
    }
    node.removeChild(old);
    return node;
  };
  textNodeSplitRe = /({{)|(}})/;
  processNode = function(context, node) {
    return processAttributes(context, node).then(function(pragmas) {
      var n, replacements;
      if (pragmas.remove && node.parentNode) {
        node.parentNode.removeChild(node);
        return;
      }
      if (node.nodeType === 3) {
        replacements = processTextNode(context, node);
        if (replacements) {
          node = replaceChild(node.parentNode, node, replacements);
        }
        return node;
      }
      return join((function() {
        var _i, _len, _ref, _results;
        _ref = toArray(node.childNodes);
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          n = _ref[_i];
          _results.push(processNode(context, n));
        }
        return _results;
      })()).then(function() {
        return node;
      });
    });
  };
  processTextNode = function(context, node) {
    var attr, attrCtx, data, part, parts, value, _i, _len, _ref, _results;
    if (!textNodeSplitRe.test(node.data)) {
      return;
    }
    data = node.data;
    data = data.replace(/{{/g, '{{\uF001');
    parts = data.split(textNodeSplitRe);
    parts = parts.filter(function(e) {
      return e && e !== '{{' && e !== '}}';
    });
    _results = [];
    for (_i = 0, _len = parts.length; _i < _len; _i++) {
      part = parts[_i];
      if (part[0] === '\uF001') {
        _ref = getByPath(context, part.slice(1).trim()), attr = _ref[0], attrCtx = _ref[1];
        value = jQuery.isFunction(attr) ? attr.call(attrCtx) : attr;
        _results.push(value || '');
      } else {
        _results.push(part);
      }
    }
    return _results;
  };
  processAttributes = function(context, node) {
    var attr, attrCtx, show, _ref, _ref1, _ref2;
    if ((_ref = node.attributes) != null ? _ref["if"] : void 0) {
      _ref1 = getByPath(context, node.attributes["if"].value), attr = _ref1[0], attrCtx = _ref1[1];
      show = jQuery.isFunction(attr) ? attr.call(attrCtx) : attr;
      if (!show) {
        return promise({
          remove: true
        });
      }
    }
    if ((_ref2 = node.attributes) != null ? _ref2.view : void 0) {
      return getBySpec(node.attributes.view.value).then(function(viewCls) {
        var attrName, attrValue, view, viewParams, _i, _len, _ref3, _ref4;
        viewParams = {};
        _ref3 = node.attributes;
        for (_i = 0, _len = _ref3.length; _i < _len; _i++) {
          attr = _ref3[_i];
          if (!(attr.name.slice(0, 5) === 'view-')) {
            continue;
          }
          attrName = hypensToCamelCase(attr.name.slice(5));
          attrValue = context[attr.value];
          _ref4 = getByPath(context, attr.value), attrValue = _ref4[0], attrCtx = _ref4[1];
          viewParams[attrName] = jQuery.isFunction(attrValue) ? attrValue.call(attrCtx) : attrValue === void 0 ? attr.value : attrValue;
        }
        viewParams.el = node;
        view = new viewCls(viewParams);
        view.render();
        if (context.addView) {
          context.addView(view);
        }
        return {
          remove: false
        };
      });
    } else {
      return promise({
        remove: false
      });
    }
  };
  wrapTemplate = function(template, requireSingleNode) {
    var fragment, node, nodes, _i, _len;
    if (requireSingleNode == null) {
      requireSingleNode = false;
    }
    nodes = template.jquery ? template.clone() : typeof template.cloneNode === 'function' ? [template.cloneNode()] : jQuery.parseHTML(template);
    if (requireSingleNode && nodes.length !== 1) {
      throw new Error('templates only of single element are allowed');
    }
    if (nodes.length > 1 || nodes[0].nodeType === 3) {
      fragment = document.createDocumentFragment();
      for (_i = 0, _len = nodes.length; _i < _len; _i++) {
        node = nodes[_i];
        fragment.appendChild(node);
      }
      return fragment;
    } else {
      return nodes[0];
    }
  };
  View = (function(_super) {

    __extends(View, _super);

    View.prototype.template = void 0;

    View.from = function(template, options) {
      var node, view;
      node = wrapTemplate(template, true);
      view = new this({
        el: node
      });
      return processNode(view, node).then(function() {
        view.render();
        return view;
      });
    };

    function View() {
      View.__super__.constructor.apply(this, arguments);
      this.views = [];
    }

    View.prototype.processDOM = function(template, localContext) {
      var context, node;
      node = wrapTemplate(template);
      context = localContext ? _.extend(Object.create(this), localContext) : this;
      return processNode(context, node);
    };

    View.prototype.renderDOM = function(template, localContext) {
      var _this = this;
      return this.processDOM(template, localContext).then(function(node) {
        _this.$el.append(node);
        return _this;
      });
    };

    View.prototype.addView = function(view) {
      return this.views.push(view);
    };

    View.prototype.remove = function() {
      var view, _i, _len, _ref, _results;
      View.__super__.remove.apply(this, arguments);
      _ref = this.views;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        view = _ref[_i];
        _results.push(view.remove());
      }
      return _results;
    };

    return View;

  })(Backbone.View);
  return {
    View: View
  };
});
